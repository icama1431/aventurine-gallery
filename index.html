<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- FB / LINE 預覽設定 -->
    <meta property="og:title" content="Cinematic Canvas | Aventurine">
    <meta property="og:description" content="卡卡瓦夏 - 「幸運，從來不是偶然的施捨。」">
    <meta property="og:type" content="website">
    <meta property="og:image" content="https://live.staticflickr.com/65535/55036747407_96aaeaa0fb_c.jpg">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">

    <title>Cinematic Canvas | It's All or Nothing</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@300;500;700&family=Playfair+Display:ital,wght@1,400;1,700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --gold: #d4af37;
            --teal: #0d3b3f;
            --luxury-gold: linear-gradient(135deg, #d4af37 0%, #f9e2af 50%, #b8860b 100%);
        }
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background-color: #000000; overflow: hidden;
            font-family: 'Noto Serif TC', serif;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            touch-action: manipulation;
        }
        
        #main-canvas { 
            position: absolute;
            top: 0; left: 0;
            width: 100vw; height: 100vh;
            display: block;
            z-index: 1;
        }

        /* 膠卷雜訊層：Safari 優化透明度 */
        #noise-canvas {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 10;
            opacity: 0.03;
            pointer-events: none;
            will-change: transform;
        }

        #particle-canvas { 
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 5;
        }

        .ui-layer { pointer-events: none; user-select: none; z-index: 20; }
        .interactive-ui { pointer-events: auto; }
        
        #bg-slideshow {
            position: absolute;
            inset: 0;
            z-index: 2;
            opacity: 0.1; 
            pointer-events: none;
        }
        .bg-slide {
            position: absolute;
            inset: 0;
            background-size: cover;
            background-position: center;
            opacity: 0;
            transition: opacity 2.5s ease-in-out;
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        .gold-glow {
            text-shadow: 0 0 15px rgba(212, 175, 55, 0.4), 0 0 35px rgba(13, 59, 63, 0.6);
        }

        .aventurine-btn {
            background: rgba(13, 59, 63, 0.5);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(212, 175, 55, 0.4);
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
            background-image: linear-gradient(120deg, transparent 30%, rgba(255,255,255,0.1) 45%, rgba(255,255,255,0.1) 50%, transparent 65%);
            background-size: 200% 100%;
            animation: shimmer 5s infinite linear;
            cursor: pointer !important;
        }

        .back-btn-style {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(212, 175, 55, 0.2);
            opacity: 0.35;
            transition: all 0.5s cubic-bezier(0.19, 1, 0.22, 1);
            border-radius: 50%;
            width: 38px; height: 38px;
            display: flex; align-items: center; justify-content: center;
        }
        .back-btn-style:hover {
            opacity: 1;
            border-color: rgba(212, 175, 55, 0.8);
            transform: scale(1.1);
        }
        
        .cursor-prev { cursor: w-resize; }
        .cursor-next { cursor: e-resize; }

        .corner-deco {
            position: absolute;
            width: 24px; height: 24px;
            border: 1px solid rgba(212, 175, 55, 0.2);
            pointer-events: none;
            z-index: 15;
        }

        ::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="flex items-center justify-center">

    <!-- 膠卷微粒畫布 -->
    <canvas id="noise-canvas"></canvas>

    <!-- 首頁 Overlay -->
    <div id="overlay" class="fixed inset-0 z-[60] flex flex-col items-center justify-center bg-[#030808] transition-all duration-1000">
        <canvas id="particle-canvas"></canvas>
        <div id="bg-slideshow">
            <div id="slide-1" class="bg-slide"></div>
            <div id="slide-2" class="bg-slide"></div>
        </div>

        <div class="relative z-10 flex flex-col items-center px-6">
            <div class="flex items-center gap-6 mb-6 opacity-40">
                <div class="h-[1px] w-12 md:w-16 bg-[#d4af37]"></div>
                <p class="text-[9px] md:text-[10px] text-[#d4af37] tracking-[1.2em] uppercase font-bold text-center">The Strategic Gamble</p>
                <div class="h-[1px] w-12 md:w-16 bg-[#d4af37]"></div>
            </div>

            <div class="overflow-hidden px-4 mb-4 text-center">
                <h1 id="brand-title" class="text-white text-4xl md:text-6xl lg:text-7xl font-light opacity-0 translate-y-10 tracking-[0.25em] gold-glow uppercase">
                    IT'S <span class="font-serif italic font-bold">ALL</span> OR <span class="font-serif italic font-bold">NOTHING</span>
                </h1>
            </div>
            
            <p id="sub-brand" class="text-[#d4af37] text-[10px] md:text-[12px] tracking-[1.5em] mb-16 opacity-0 uppercase font-light text-center">Luck is the only skill</p>

            <div id="loading-status" class="text-[#d4af37]/30 text-[9px] tracking-[0.6em] mb-12 uppercase italic text-center">Decrypting the deck...</div>
            
            <button id="entry-btn" class="hidden interactive-ui aventurine-btn group relative px-12 md:px-20 py-4 md:py-5 text-white/80 hover:text-white transition-all duration-1000 tracking-[0.8em] text-[10px] md:text-[11px] overflow-hidden uppercase z-[70]">
                <span class="relative z-10">Take the chance</span>
            </button>
        </div>
    </div>

    <!-- 影集 UI 層 -->
    <div id="photo-ui" class="ui-layer fixed inset-0 opacity-0 pointer-events-none transition-opacity duration-1000 z-[80]">
        
        <div class="corner-deco top-6 left-6 border-r-0 border-b-0"></div>
        <div class="corner-deco top-6 right-6 border-l-0 border-b-0"></div>
        <div class="corner-deco bottom-6 left-6 border-r-0 border-t-0"></div>
        <div class="corner-deco bottom-6 right-6 border-l-0 border-t-0"></div>

        <div class="fixed top-4 left-4 md:top-6 md:left-6 interactive-ui">
            <button id="back-btn" class="back-btn-style text-[#d4af37]" title="Leave the table">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <path d="M18 6L6 18M6 6l12 12"/>
                </svg>
            </button>
        </div>

        <div class="fixed top-5 right-6 md:top-7 md:right-10 text-[10px] md:text-[11px] tracking-[0.4em] text-[#d4af37]/30 font-bold">
            HAND <span id="current-num" class="text-white/60">00</span> / <span id="total-num">00</span>
        </div>

        <div class="fixed bottom-20 md:bottom-24 left-0 w-full flex justify-center px-10">
            <div id="subtitle-container" class="max-w-4xl text-center">
                <p id="subtitle-text" class="text-white/90 text-base md:text-xl font-light leading-relaxed opacity-0 tracking-[0.2em] italic" style="text-shadow: 0 5px 15px rgba(0,0,0,1)"></p>
            </div>
        </div>
    </div>

    <canvas id="main-canvas"></canvas>

    <script>
        /**
         * Safari 相容性優化：
         * 1. 使用 await img.decode() 確保圖片進入 GPU
         * 2. 針對 Safari Resize 事件頻繁觸發進行防抖處理
         */
        const canvas = document.getElementById('main-canvas');
        const ctx = canvas.getContext('2d', { alpha: false }); // 關閉透明度提升 Canvas 效能
        const pCanvas = document.getElementById('particle-canvas');
        const pCtx = pCanvas.getContext('2d');
        const nCanvas = document.getElementById('noise-canvas');
        const nCtx = nCanvas.getContext('2d');

        let images = [];
        let currentIdx = -1;
        let isTransitioning = false;
        let stopParticles = false;
        let isInGalleryMode = false;

        const bgImagesUrls = [
            'https://live.staticflickr.com/65535/55036747752_e3495334e3_h.jpg',
            'https://live.staticflickr.com/65535/55037653101_ac96d8296e_h.jpg',
            'https://live.staticflickr.com/65535/55036747407_96aaeaa0fb_c.jpg'
        ];
        let currentBgIdx = 0;

        // --- 粒子系統 ---
        let particles = [];
        class Particle {
            constructor() { this.reset(); }
            reset() {
                this.x = Math.random() * pCanvas.width;
                this.y = -50 - Math.random() * 200;
                this.size = 10 + Math.random() * 20;
                this.speed = 0.5 + Math.random() * 0.8;
                this.rotation = Math.random() * Math.PI * 2;
                this.rotSpeed = (Math.random() - 0.5) * 0.01;
                this.type = Math.random() > 0.5 ? 'chip' : 'card';
                this.opacity = 0.1 + Math.random() * 0.2;
            }
            update() {
                this.y += this.speed;
                this.rotation += this.rotSpeed;
                if (this.y > pCanvas.height + 50) this.reset();
            }
            draw() {
                pCtx.save();
                pCtx.translate(this.x, this.y); pCtx.rotate(this.rotation);
                pCtx.globalAlpha = this.opacity;
                pCtx.strokeStyle = '#d4af37'; pCtx.lineWidth = 1;
                if (this.type === 'chip') {
                    pCtx.beginPath(); pCtx.arc(0, 0, this.size, 0, Math.PI * 2); pCtx.stroke();
                } else {
                    pCtx.strokeRect(-this.size/2, -this.size * 0.7, this.size, this.size * 1.4);
                }
                pCtx.restore();
            }
        }

        // --- 膠卷微粒動畫 (Safari 效能優化版) ---
        let lastNoiseTime = 0;
        function createNoise() {
            if (nCanvas.width === 0 || nCanvas.height === 0) return;
            // 降低雜訊更新頻率至約 15fps，節省 Safari GPU
            const now = Date.now();
            if (now - lastNoiseTime < 60) return;
            lastNoiseTime = now;

            try {
                const idata = nCtx.createImageData(nCanvas.width, nCanvas.height);
                const buffer32 = new Uint32Array(idata.data.buffer);
                for (let i = 0; i < buffer32.length; i++) {
                    if (Math.random() < 0.05) buffer32[i] = 0x11000000;
                }
                nCtx.putImageData(idata, 0, 0);
            } catch (e) {}
        }

        function animateNoise() {
            createNoise();
            requestAnimationFrame(animateNoise);
        }

        function initParticles() {
            particles = [];
            const count = window.innerWidth < 768 ? 20 : 40;
            for (let i = 0; i < count; i++) particles.push(new Particle());
        }
        function animateParticles() {
            if (stopParticles) return;
            pCtx.clearRect(0, 0, pCanvas.width, pCanvas.height);
            particles.forEach(p => { p.update(); p.draw(); });
            requestAnimationFrame(animateParticles);
        }

        // --- 場景配置 ---
        const sceneConfig = [
            { url: 'https://live.staticflickr.com/65535/55036738467_6e8273bf12_h.jpg', text: '「幸運，從來不是偶然的施捨。」' },
            { url: 'https://live.staticflickr.com/65535/55037821323_0a332f06ea_h.jpg', text: '「既然籌碼已經上桌，就沒有收回的道理。」' },
            { url: 'https://live.staticflickr.com/65535/55037642501_f0801b7f90_h.jpg', text: '「這張牌，賭上我的靈魂與未來。」' },
            { url: 'https://live.staticflickr.com/65535/55037821968_6bb08b5b77_h.jpg', text: '「命運從不憐憫弱者，它只眷顧敢於 All-in 的瘋子。」' },
            { url: 'https://live.staticflickr.com/65535/55037986890_aac979b78f_h.jpg', text: '「當金色的雨落下時，遊戲才剛要開始。」' },
            { url: 'https://live.staticflickr.com/65535/55037987335_be8b101116_h.jpg', text: '「勝負已分。而你，是我的戰利品。」' },
            { url: 'https://live.staticflickr.com/65535/55036740552_22f10474b4_h.jpg', text: '「煙霧繚繞間，我彷彿看見了死神的微笑。」' },
            { url: 'https://live.staticflickr.com/65535/55037897854_8e08759781_h.jpg', text: '「這張王牌，是為了與你重逢而留的。」' },
            { url: 'https://live.staticflickr.com/65535/55037644446_d96c896ab6_h.jpg', text: '「願母神賜予我，最後的幸運。」' },
            { url: 'https://live.staticflickr.com/65535/55037988640_4f2af36145_h.jpg', text: '「籌碼已經落下。」' },
            { url: 'https://live.staticflickr.com/65535/55037824943_1893edb665_h.jpg', text: '「遊戲還沒結束。」' },
            { url: 'https://live.staticflickr.com/65535/55037653306_1a25c0a320_h.jpg', text: '「看穿一切的雙眼。」' },
            { url: 'https://live.staticflickr.com/65535/55037989645_d9a22961c8_c.jpg', text: '「這就是我的底牌。」' },
            { url: 'https://live.staticflickr.com/65535/55037645801_608474bb7f_c.jpg', text: '「籌碼在指尖旋轉。」' },
            { url: 'https://live.staticflickr.com/65535/55037990140_b36155f3a5_h.jpg', text: '「命運的豪賭。」' },
            { url: 'https://live.staticflickr.com/65535/55036743047_db2a13730c_h.jpg', text: '「不可逾越的界限。」' },
            { url: 'https://live.staticflickr.com/65535/55036743237_af01d41fda_h.jpg', text: '「最後的一眼。」' },
            { url: 'https://live.staticflickr.com/65535/55037901284_b344569e07_h.jpg', text: '「金色的誘惑。」' },
            { url: 'https://live.staticflickr.com/65535/55036743462_956d4080a9_h.jpg', text: '「洗牌，重新開始。」' },
            { url: 'https://live.staticflickr.com/65535/55037902329_6d58f7c54d_c.jpg', text: '「你準備好輸了嗎？」' },
            { url: 'https://live.staticflickr.com/65535/55037648256_9a2a042d92_h.jpg', text: '「深邃的目光。」' },
            { url: 'https://live.staticflickr.com/65535/55037648386_ba9f62d887_h.jpg', text: '「無關運氣。」' },
            { url: 'https://live.staticflickr.com/65535/55037648666_ee22deafe3_h.jpg', text: '「一切都在掌握之中。」' },
            { url: 'https://live.staticflickr.com/65535/55036745327_83799b354b_h.jpg', text: '「優雅的謝幕。」' },
            { url: 'https://live.staticflickr.com/65535/55037649091_58418357eb_h.jpg', text: '「賭徒的尊嚴。」' },
            { url: 'https://live.staticflickr.com/65535/55037828893_fc460d8d1d_h.jpg', text: '「最後的黃金時刻。」' },
            { url: 'https://live.staticflickr.com/65535/55036746207_be7e4b2aae_c.jpg', text: '「籌碼已至，生死有命。」' },
            { url: 'https://live.staticflickr.com/65535/55037829178_a7a92613a0_h.jpg', text: '「最後的豪賭。」' },
            { url: 'https://live.staticflickr.com/65535/55036746507_f9d6f1c8c5_h.jpg', text: '「願母神保佑。」' },
            { url: 'https://live.staticflickr.com/65535/55037650041_664169bdd3_h.jpg', text: '「再會，贏家。」' },
            { url: 'https://live.staticflickr.com/65535/55037650146_8fc44cdbe4_h.jpg', text: '「遊戲結束。」' },
            { url: 'https://live.staticflickr.com/65535/55037994250_40347a0dbd_h.jpg', text: '「賭場的盡頭。」' }
        ];

        function resize() {
            const w = window.innerWidth;
            const h = window.innerHeight;
            canvas.width = nCanvas.width = pCanvas.width = w;
            canvas.height = nCanvas.height = pCanvas.height = h;
            initParticles();
            if (currentIdx >= 0 && images[currentIdx]) drawScene(images[currentIdx], 1);
        }
        window.addEventListener('resize', resize);
        resize();

        async function preloadAssets() {
            const imgPromises = sceneConfig.map((scene) => {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.crossOrigin = "anonymous";
                    img.onload = async () => {
                        try {
                            // Safari 優化：確保解碼完成才算加載成功
                            if (img.decode) await img.decode();
                            resolve(img);
                        } catch (e) {
                            resolve(img); // 回退方案
                        }
                    };
                    img.onerror = () => resolve(null);
                    img.src = scene.url;
                });
            });
            images = await Promise.all(imgPromises);
            document.getElementById('total-num').innerText = String(images.length).padStart(2, '0');
            document.getElementById('loading-status').classList.add('hidden');
            document.getElementById('entry-btn').classList.remove('hidden');
        }

        function startBgSlideshow() {
            const slides = [document.getElementById('slide-1'), document.getElementById('slide-2')];
            let activeIdx = 0;
            slides[0].style.backgroundImage = `url(${bgImagesUrls[0]})`;
            slides[0].style.opacity = 1;
            setInterval(() => {
                if (stopParticles) return;
                const nextBgIdx = (currentBgIdx + 1) % bgImagesUrls.length;
                const nextSlideIdx = (activeIdx + 1) % 2;
                const currentSlide = slides[activeIdx];
                const nextSlide = slides[nextSlideIdx];
                nextSlide.style.backgroundImage = `url(${bgImagesUrls[nextBgIdx]})`;
                currentSlide.style.opacity = 0;
                nextSlide.style.opacity = 1;
                currentBgIdx = nextBgIdx;
                activeIdx = nextSlideIdx;
            }, 6000);
        }

        function drawScene(img, opacity) {
            if (!img || img.width === 0) return;
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            const imgAspect = img.width / img.height;
            const canvasAspect = canvas.width / canvas.height;
            const fitScale = 0.98;
            let drawW, drawH;
            
            if (canvasAspect > imgAspect) {
                drawH = canvas.height * fitScale; drawW = drawH * imgAspect;
            } else {
                drawW = canvas.width * fitScale; drawH = drawW / imgAspect;
            }
            const drawX = (canvas.width - drawW) / 2;
            const drawY = (canvas.height - drawH) / 2;
            
            ctx.globalAlpha = opacity;
            ctx.drawImage(img, drawX, drawY, drawW, drawH);
            ctx.globalAlpha = 1.0;
        }

        function renderCurrentScene() {
            if (currentIdx < 0 || !images[currentIdx]) return;
            const img = images[currentIdx];
            const scene = sceneConfig[currentIdx];
            document.getElementById('current-num').innerText = String(currentIdx + 1).padStart(2, '0');
            
            drawScene(img, 1);
            
            gsap.fromTo("#subtitle-text", 
                { opacity: 0, y: 15 }, 
                { opacity: 1, y: 0, duration: 1.0, ease: "power2.out", 
                  onStart: () => { document.getElementById('subtitle-text').innerText = scene.text; } 
                }
            );
        }

        function handleNavigation(clientX) {
            if (!isInGalleryMode || isTransitioning) return;
            isTransitioning = true;
            if (clientX < window.innerWidth * 0.4) {
                currentIdx = (currentIdx - 1 + images.length) % images.length;
            } else {
                currentIdx = (currentIdx + 1) % images.length;
            }
            renderCurrentScene();
            // Safari 優化：給予更長的緩衝時間避免連點卡死
            setTimeout(() => { isTransitioning = false; }, 350);
        }

        function exitExperience() {
            isInGalleryMode = false; stopParticles = false;
            document.getElementById('overlay').style.display = 'flex';
            gsap.to("#overlay", { opacity: 1, duration: 0.8 });
            gsap.to("#photo-ui", { opacity: 0, pointerEvents: 'none', duration: 0.5 });
            gsap.to(canvas, { opacity: 0, duration: 0.5, onComplete: () => {
                ctx.fillStyle = '#000';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                canvas.style.opacity = 1; currentIdx = -1;
            }});
            animateParticles();
        }

        window.onload = async () => {
            // Safari 強制觸發一次 Resize 確保尺寸獲取正確
            resize(); 
            await preloadAssets();
            animateParticles();
            animateNoise();
            startBgSlideshow();
            gsap.to("#brand-title", { opacity: 1, y: 0, duration: 1.5, ease: "power4.out" });
            gsap.to("#sub-brand", { opacity: 0.6, duration: 1, delay: 0.5 });

            document.getElementById('entry-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                gsap.to("#overlay", { 
                    opacity: 0, duration: 0.8,
                    onComplete: () => {
                        stopParticles = true;
                        isInGalleryMode = true;
                        document.getElementById('overlay').style.display = 'none';
                        document.getElementById('photo-ui').classList.remove('pointer-events-none');
                        gsap.to("#photo-ui", { opacity: 1, duration: 0.5 });
                        currentIdx = 0; renderCurrentScene();
                    }
                });
            });
            document.getElementById('back-btn').addEventListener('click', (e) => {
                e.stopPropagation(); exitExperience();
            });
        };

        window.addEventListener('click', (e) => {
            if (!isInGalleryMode) return;
            if (e.target.closest('.interactive-ui')) return;
            handleNavigation(e.clientX);
        });

        window.addEventListener('mousemove', (e) => {
            if (!isInGalleryMode) {
                document.body.classList.remove('cursor-prev', 'cursor-next');
                return;
            }
            if (e.clientX < window.innerWidth * 0.4) {
                document.body.classList.add('cursor-prev');
                document.body.classList.remove('cursor-next');
            } else {
                document.body.classList.add('cursor-next');
                document.body.classList.remove('cursor-prev');
            }
        });
    </script>
</body>
</html>
